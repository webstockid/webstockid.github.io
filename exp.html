<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Masa Aktif Member VIP</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3498db">

<!-- Font & CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="stockid_script/exp.css">

<style>
/* Tambahan CSS tombol WA dan warning */
.wa-btn{display:inline-block;margin-top:6px;padding:6px 10px;background:#25d366;color:#fff;border-radius:6px;font-size:13px;text-decoration:none;}
.warn{display:inline-block;margin-left:6px;padding:2px 6px;border-radius:4px;font-size:11px;color:#fff;}
.warn.h7{background:#f1c40f;}
.warn.h3{background:#e67e22;}
.warn.expired{background:#e74c3c;}
.notif-btn{background:#3498db;color:#fff;padding:8px 12px;border:none;border-radius:6px;margin-bottom:10px;}
</style>

</head>
<body>

<h2>Monitoring Masa Aktif Member VIP</h2>

<button onclick="enableNotif()" class="notif-btn">üîî Aktifkan Reminder</button>
<audio id="notifSound" src="stockid_suara/alert.mp3"></audio>

<div class="stat-box" id="statistik"></div>

<div class="controls">
	<input id="search" placeholder="Cari nama kamu...">
	<select id="filter">
		<option value="all">Semua</option>
		<option value="1">1 Bulan</option>
		<option value="2">2 Bulan</option>
		<option value="3">3 Bulan</option>
		<option value="6">6 Bulan</option>
		<option value="12">1 Tahun</option>
		<option value="expired">Expired</option>
	</select>
</div>

<div id="list"></div>

<script>
/* ================= DATA MEMBER ================= */
const members = [
	{ nama:"Mas. Yayat", wa:"82967078794", expired:"2027-02-21", history:[12] },
	{ nama:"Mas. Dimas", wa:"6282288133212", expired:"2027-02-11", history:[1,12] },
	{ nama:"Mas. Devan", wa:"6285800322160", expired:"2026-09-18", history:[1,6] },
	{ nama:"Mas. Ardha", wa:"6281542779853", expired:"2026-08-25", history:[3,6] },
	{ nama:"Mas. Vani", wa:"6289662208826", expired:"2026-08-09", history:[6] },
	{ nama:"Mas. Tito", wa:"6281270370727", expired:"2026-06-30", history:[3,3] },
	{ nama:"Mas. Farhan", wa:"6288221513462", expired:"2026-06-22", history:[1,3] },
	{ nama:"Mas. Yoga", wa:"6282382795953", expired:"2026-06-18", history:[3,3] },
	{ nama:"Mas. Dika", wa:"628131093311", expired:"2026-06-02", history:[3] },
	{ nama:"Mas. Adam", wa:"6282140581317", expired:"2026-05-26", history:[3] },
	{ nama:"Mas. Tomy", wa:"6289609809039", expired:"2026-05-22", history:[1,2,2] },
	{ nama:"Mas. Dedi", wa:"6285951568082", expired:"2026-05-21", history:[1,3] },
	{ nama:"Mas. Arif", wa:"6285265337779", expired:"2026-05-16", history:[1,3] },
	{ nama:"Mas. Ananda", wa:"6282256863256", expired:"2026-05-12", history:[3] },
	{ nama:"Mas. Anggoro", wa:"6289525567420", expired:"2026-05-10", history:[3] },
	{ nama:"Mba. Puspita", wa:"6282146281427", expired:"2026-05-10", history:[3] },
	{ nama:"Mas. Faisal", wa:"6285727473240", expired:"2026-05-07", history:[1,2] },
	{ nama:"Mas. Abdul", wa:"6285704755602", expired:"2026-05-06", history:[1,2] },
	{ nama:"Mba. Fauziah", wa:"6285753648079", expired:"2026-05-05", history:[1,2] },
	{ nama:"Mas. Ardan", wa:"628888136363", expired:"2026-04-28", history:[2] },
	{ nama:"Mas. Dwiky", wa:"628116383088", expired:"2026-04-27", history:[1,1,2] },
	{ nama:"Mas. Ihsan", wa:"6282215352174", expired:"2026-04-27", history:[2] },
	{ nama:"Mba. Dhila", wa:"6289528936511", expired:"2026-04-26", history:[1,1] },
	{ nama:"Mas. Roid", wa:"6287819304040", expired:"2026-04-25", history:[1,2] },
	{ nama:"Mas. Made", wa:"6281353043869", expired:"2026-02-05", history:[1,2] }
];

/* ================= KONSTANTA ================= */
const DAY=86400000,HOUR=3600000,MIN=60000;
const lastMonth = m => m.history.at(-1)||0;
const target = d => new Date(d+"T00:00:00").getTime();

/* ================= FORMAT ================= */
function sisa(ms){if(ms<=0)return "Expired";const h=Math.floor(ms/DAY),j=Math.floor(ms%DAY/HOUR),m=Math.floor(ms%HOUR/MIN);return `${h} Hari ${j} Jam ${m} Menit`;}
function kelas(b,ms){if(ms<=0)return "expired";return b==1?"satu":b==2?"dua":b==3?"tiga":b==6?"enam":"setahun";}
const badge = a => a.length==1?`+${a[0]} bulan`:`+${a.slice(0,-1).join(", ")} & ${a.at(-1)} bulan`;
const join = a => a.map(b=>`${b} Bulan`).join(" + ");

/* ================= WARNING / NOTIF ================= */
function checkWarning(ms) {
    const days = Math.ceil(ms / DAY);
    if(days <= 0) return "expired";
    if(days <= 3) return "h3";
    if(days <= 7) return "h7";
    return null;
}

function notifKey(m, w){ return `notif_${m.wa}_${w}`; }

function pushNotif(title, body){
    if(Notification.permission !== "granted") return;
    new Notification(title,{body:body,icon:"stockid_gambar/thumb.jpg",vibrate:[200,100,200]});
    document.getElementById("notifSound").play().catch(()=>{});
}

function waText(m,w){
    if(w=="h7") return `Halo ${m.nama} üëã\nMasa aktif Stock ID VIP kamu akan habis 7 hari lagi.\nExpired: ${m.expired}`;
    if(w=="h3") return `Halo ${m.nama} üëã\nMasa aktif Stock ID VIP kamu tinggal 3 hari lagi ‚è∞\nExpired: ${m.expired}`;
    if(w=="expired") return `Halo ${m.nama} üëã\nMasa aktif Stock ID VIP kamu sudah EXPIRED ‚ùå`;
    return "";
}

function autoWA(m,w){
    const key = `wa_${m.wa}_${w}`;
    if(localStorage.getItem(key)) return;
    window.open(`https://wa.me/${m.wa}?text=${encodeURIComponent(waText(m,w))}`,"_blank");
    localStorage.setItem(key,"1");
}

/* ================= STAT ================= */
function renderStat(data){
    const box = document.getElementById("statistik"); box.innerHTML="";
    const map = {1:0,2:0,3:0,6:0,12:0,x:0};
    data.forEach(m => {if(m.ms<=0) map.x++; else map[lastMonth(m)]++;});
    const rows = [[1,"1 Bulan"],[2,"2 Bulan"],[3,"3 Bulan"],[6,"6 Bulan"],[12,"1 Tahun"],["x","Expired"]];
    const max = Math.max(...Object.values(map),1);
    rows.forEach(r => {box.innerHTML += `<div class="stat-row"><div>${r[1]} (${map[r[0]]})</div><div class="bar"><div class="bar-fill" style="width:${map[r[0]]/max*30}%"></div></div></div>`;});
}

/* ================= RENDER ================= */
function render(){
    const list = document.getElementById("list");
    list.innerHTML = "";
    const key = search.value.toLowerCase();
    const f = filter.value;

    members.forEach(m=> m.ms = target(m.expired) - Date.now());
    const sorted = [...members].sort((a,b)=>b.ms - a.ms);
    renderStat(sorted);

    sorted.forEach(m=>{
        const lm = lastMonth(m);
        if(!m.nama.toLowerCase().includes(key)) return;
        if(f==="expired" && m.ms>0) return;
        if(f!=="all" && f!=="expired" && lm!=f) return;

        const w = checkWarning(m.ms);
        if(w){
            const keyN = notifKey(m,w);
            if(!localStorage.getItem(keyN)){
                let title="‚è∞ Masa Aktif Member";
                let msg="";
                if(w=="h7") msg=`${m.nama} akan expired 7 hari lagi`;
                if(w=="h3") msg=`${m.nama} tinggal 3 hari lagi`;
                if(w=="expired") msg=`${m.nama} sudah EXPIRED`;
                pushNotif(title,msg);
                autoWA(m,w);
                localStorage.setItem(keyN,"1");
            }
        }

        const div = document.createElement("div");
        div.className = "member "+kelas(lm,m.ms);
        div.innerHTML = `
            <b>Nama: ${m.nama}</b><br>
            Expired: ${m.expired}<br>
            Sisa Waktu: ${sisa(m.ms)}
            ${w?`<span class="warn ${w}">${w.toUpperCase()}</span>`:""}
            <span class="badge">${badge(m.history)}</span>
            <div class="history">Join Kelas: ${join(m.history)}</div>
            <a class="wa-btn" target="_blank" href="https://wa.me/${m.wa}?text=${encodeURIComponent(waText(m,w||"h7"))}"><i class="fa fa-whatsapp"></i> Reminder</a>
        `;
        list.appendChild(div);
    });
}

search.oninput = render;
filter.onchange = render;
setInterval(render,10000);
render();

/* ================= NOTIF & SERVICE WORKER ================= */
function enableNotif(){
    if(!("Notification" in window)){ alert("Browser tidak mendukung notifikasi"); return; }
    Notification.requestPermission().then(p=>{ if(p==="granted") alert("Notifikasi diaktifkan ‚úÖ"); });
}

if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js').then(reg=>{console.log("SW registered",reg);}).catch(err=>{console.log("SW failed",err);});
    navigator.serviceWorker.addEventListener('message', e=>{
        if(e.data.type==='check-reminder') render();
    });
}
</script>

</body>
</html>
